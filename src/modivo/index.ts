//&filters[akcja][in][]=bestsellers_1&filters[omnibus_discount][range]=0-1&filters[rozmiar_b][begins][]=spodnie_jeansy_i_shorty_1%3Am&categories[]=mezczyzni&select[]=product_active&select[]=product_badge&select[]=manufacturer&select[]=manufacturer_with_collection&select[]=clothes_size&select[]=main_color&select[]=discount&select[]=rozmiar_karta_produktu&select[]=eco_friendly&select[]=fason&select[]=final_price&select[]=footwear_size&select[]=hot_deal&select[]=images&select[]=modivo_fashion_club&select[]=model&select[]=nazwa_wyswietlana&select[]=nazwa_wyswietlana_front&select[]=okazja&select[]=price&select[]=producent&select[]=product_group_associated&select[]=series_name&select[]=size_type&select[]=index&select[]=akcje_marketingowe&select[]=url_key&select[]=video_url&select[]=okazja&select[]=producent&select[]=footwear_size&select[]=clothes_size&select[]=health_beauty_size&select[]=home_decor_size&select[]=eco_friendly&select[]=modivo_fashion_club&select[]=action_label&select[]=product_color_variants_count&select[]=omnibus_price&select[]=omnibus_discount&select[]=short_name&select[]=outlet&support_aggregated_size_b=1
//https://modivo.pl/t-api/rest/search/modivo/v5/search_web3?channel=modivo&currency=PLN&locale=pl_PL&limit=72&page=1&categories[]=mezczyzni%2Fsport&select[]=product_active&select[]=product_badge&select[]=manufacturer&select[]=manufacturer_with_collection&select[]=clothes_size&select[]=main_color&select[]=discount&select[]=rozmiar_karta_produktu&select[]=eco_friendly&select[]=fason&select[]=final_price&select[]=footwear_size&select[]=hot_deal&select[]=images&select[]=modivo_fashion_club&select[]=model&select[]=nazwa_wyswietlana&select[]=nazwa_wyswietlana_front&select[]=okazja&select[]=price&select[]=producent&select[]=product_group_associated&select[]=series_name&select[]=size_type&select[]=index&select[]=akcje_marketingowe&select[]=url_key&select[]=video_url&select[]=okazja&select[]=producent&select[]=footwear_size&select[]=clothes_size&select[]=health_beauty_size&select[]=home_decor_size&select[]=eco_friendly&select[]=modivo_fashion_club&select[]=action_label&select[]=product_color_variants_count&select[]=omnibus_price&select[]=omnibus_discount&select[]=short_name&select[]=outlet&support_aggregated_size_b=1
//https://modivo.pl/t-api/rest/search/modivo/v5/search_web3?channel=modivo&currency=PLN&locale=pl_PL&limit=72&page=1&sortType=price&sortOrder=asc&categories[]=mezczyzni%2Fsport&select[]=product_active&select[]=product_badge&select[]=manufacturer&select[]=manufacturer_with_collection&select[]=clothes_size&select[]=main_color&select[]=discount&select[]=rozmiar_karta_produktu&select[]=eco_friendly&select[]=fason&select[]=final_price&select[]=footwear_size&select[]=hot_deal&select[]=images&select[]=modivo_fashion_club&select[]=model&select[]=nazwa_wyswietlana&select[]=nazwa_wyswietlana_front&select[]=okazja&select[]=price&select[]=producent&select[]=product_group_associated&select[]=series_name&select[]=size_type&select[]=index&select[]=akcje_marketingowe&select[]=url_key&select[]=video_url&select[]=okazja&select[]=producent&select[]=footwear_size&select[]=clothes_size&select[]=health_beauty_size&select[]=home_decor_size&select[]=eco_friendly&select[]=modivo_fashion_club&select[]=action_label&select[]=product_color_variants_count&select[]=omnibus_price&select[]=omnibus_discount&select[]=short_name&select[]=outlet&support_aggregated_size_b=1
//https://modivo.pl/t-api/rest/search/modivo/v5/search_web/filters?channel=modivo&currency=PLN&locale=pl_PL&filters[rozmiar_b][begins][]=odziez_1%3Am&filters[rozmiar_b][begins][]=spodnie_jeansy_i_shorty_1%3Am&filters[rozmiar_b][begins][]=czapki_i_kapelusze_2%3Anone%3Am&filters[rozmiar_b][begins][]=rekawiczki_2%3Anone%3Am&filters[kolor][in][]=czarny&filters[kolor][in][]=szary&filters[kolor][in][]=granatowy&filters[kolor][in][]=niebieski&filters[kolor][in][]=zielony&filters[kolor][in][]=czerwony&filters[kolor][in][]=bialy&filters[kolor][in][]=bezowy&filters[kolor][in][]=zolty&filters[kolor][in][]=brazowy&filters[kolor][in][]=khaki&filters[kolor][in][]=kolorowy&filters[cena][range]=102-2700&filters[marka][in][]=4f&filters[marka][in][]=adidas&filters[marka][in][]=adidas_originals&filters[marka][in][]=adidas_performance&filters[marka][in][]=adidas_sportswear&filters[marka][in][]=ale_cycling&filters[marka][in][]=alpinus&filters[marka][in][]=asics&filters[marka][in][]=billabong&filters[marka][in][]=black_diamond&filters[marka][in][]=brandit&filters[marka][in][]=brubeck&filters[marka][in][]=brunotti&filters[marka][in][]=buff&filters[marka][in][]=calvin_klein_performance&filters[marka][in][]=champion&filters[marka][in][]=cmp&filters[marka][in][]=columbia&filters[marka][in][]=converse&filters[marka][in][]=craft&filters[marka][in][]=dainese&filters[marka][in][]=dare2b&filters[marka][in][]=dc&filters[marka][in][]=didriksons&filters[marka][in][]=dolomite&filters[marka][in][]=dynafit&filters[marka][in][]=ea7_emporio_armani&filters[marka][in][]=ellesse&filters[marka][in][]=emporio_armani_underwear&filters[marka][in][]=fila&filters[marka][in][]=fox_racing&filters[marka][in][]=gorilla_wear&filters[marka][in][]=haglofs&filters[marka][in][]=halti&filters[marka][in][]=head&filters[marka][in][]=helly_hansen&filters[marka][in][]=henderson&filters[marka][in][]=huf&filters[marka][in][]=jack_wolfskin&filters[marka][in][]=kappa&filters[marka][in][]=karl_kani&filters[marka][in][]=kilpi&filters[marka][in][]=kombi&filters[marka][in][]=levis_r&filters[marka][in][]=maloja&filters[marka][in][]=mammut&filters[marka][in][]=marmot&filters[marka][in][]=mico&filters[marka][in][]=millet&filters[marka][in][]=musto&filters[marka][in][]=new_balance&filters[marka][in][]=new_era&filters[marka][in][]=nike&filters[marka][in][]=north_sails&filters[marka][in][]=northwave&filters[marka][in][]=odlo&filters[marka][in][]=on&filters[marka][in][]=on_running&filters[marka][in][]=outhorn&filters[marka][in][]=palmar&filters[marka][in][]=peak_performance&filters[marka][in][]=poc&filters[marka][in][]=protest&filters[marka][in][]=puma&filters[marka][in][]=quiksilver&filters[marka][in][]=rab&filters[marka][in][]=reebok&filters[marka][in][]=reebok_classic&filters[marka][in][]=refrigiwear&filters[marka][in][]=regatta&filters[marka][in][]=rip_curl&filters[marka][in][]=rocday&filters[marka][in][]=rossignol&filters[marka][in][]=rough_radical&filters[marka][in][]=salewa&filters[marka][in][]=salomon&filters[marka][in][]=schoffel&filters[marka][in][]=silvini&filters[marka][in][]=sixth_june&filters[marka][in][]=skechers&filters[marka][in][]=spyder&filters[marka][in][]=surfanic&filters[marka][in][]=the_north_face&filters[marka][in][]=under_armour&filters[marka][in][]=unfair_athletics&filters[marka][in][]=uyn&filters[marka][in][]=vans&filters[marka][in][]=weather_report&filters[marka][in][]=x_bionic&filters[marka][in][]=yeaz&filters[sport][in][]=outdoor&filters[sport][in][]=narciarstwo&filters[sport][in][]=trening_fitness&filters[sport][in][]=bieganie&filters[sport][in][]=kolarstwo&filters[sport][in][]=snowboard&filters[sport][in][]=pilka_nozna&filters[sport][in][]=sporty_wodne&filters[sport][in][]=tenis&filters[sport][in][]=wspinaczka&filters[sport][in][]=golf&filters[sport][in][]=lifestyle&filters[sport][in][]=city_trekking&filters[sport][in][]=koszykowka&filters[sport][in][]=lekkoatletyka&filters[sport][in][]=siatkowka&filters[sport][in][]=joga&filters[sport][in][]=sporty_zimowe&categories[]=mezczyzni%2Fsport&support_aggregated_size_b=1
//
//modivo.pl/t-api/rest/search/modivo/v5/search_web3?channel=modivo&currency=PLN&locale=pl_PL&limit=72&page=1&filters[akcja][in][]=bestsellers_1&filters[omnibus_discount][range]=0-1&filters[rozmiar_b][begins][]=obuwie_1%3Anone%3A35_1&filters[rozmiar_b][begins][]=bielizna_i_moda_plazowa_1%3Am&filters[cena][range]=66-421&categories[]=mezczyzni&select[]=product_active&select[]=product_badge&select[]=manufacturer&select[]=manufacturer_with_collection&select[]=clothes_size&select[]=main_color&select[]=discount&select[]=rozmiar_karta_produktu&select[]=eco_friendly&select[]=fason&select[]=final_price&select[]=footwear_size&select[]=hot_deal&select[]=images&select[]=modivo_fashion_club&select[]=model&select[]=nazwa_wyswietlana&select[]=nazwa_wyswietlana_front&select[]=okazja&select[]=price&select[]=producent&select[]=product_group_associated&select[]=series_name&select[]=size_type&select[]=index&select[]=akcje_marketingowe&select[]=url_key&select[]=video_url&select[]=okazja&select[]=producent&select[]=footwear_size&select[]=clothes_size&select[]=health_beauty_size&select[]=home_decor_size&select[]=eco_friendly&select[]=modivo_fashion_club&select[]=action_label&select[]=product_color_variants_count&select[]=omnibus_price&select[]=omnibus_discount&select[]=short_name&select[]=outlet&support_aggregated_size_b=1
//https://modivo.pl/t-api/rest/search/modivo/v5/search_web3?channel=modivo&currency=PLN&locale=pl_PL&limit=72&page=1&filters[akcja][in][]=bestsellers_1&filters[omnibus_discount][range]=0-1&filters[rozmiar_b][begins][]=obuwie_1%3Anone%3A35_1&filters[rozmiar_b][begins][]=bielizna_i_moda_plazowa_1%3Am&filters[rozmiar_b][begins][]=skarpetki_1%3Anone%3A41_2&filters[cena][range]=66-421&categories[]=mezczyzni&select[]=product_active&select[]=product_badge&select[]=manufacturer&select[]=manufacturer_with_collection&select[]=clothes_size&select[]=main_color&select[]=discount&select[]=rozmiar_karta_produktu&select[]=eco_friendly&select[]=fason&select[]=final_price&select[]=footwear_size&select[]=hot_deal&select[]=images&select[]=modivo_fashion_club&select[]=model&select[]=nazwa_wyswietlana&select[]=nazwa_wyswietlana_front&select[]=okazja&select[]=price&select[]=producent&select[]=product_group_associated&select[]=series_name&select[]=size_type&select[]=index&select[]=akcje_marketingowe&select[]=url_key&select[]=video_url&select[]=okazja&select[]=producent&select[]=footwear_size&select[]=clothes_size&select[]=health_beauty_size&select[]=home_decor_size&select[]=eco_friendly&select[]=modivo_fashion_club&select[]=action_label&select[]=product_color_variants_count&select[]=omnibus_price&select[]=omnibus_discount&select[]=short_name&select[]=outlet&support_aggregated_size_b=1
//https://modivo.pl/t-api/rest/search/modivo/v5/search_web3?channel=modivo&currency=PLN&locale=pl_PL&limit=72&page=1&filters[akcja][in][]=bestsellers_1&filters[omnibus_discount][range]=0-1&filters[rozmiar_b][begins][]=obuwie_1%3Anone%3A35_1&filters[rozmiar_b][begins][]=skarpetki_1%3Anone%3A41_2&filters[rozmiar_b][begins][]=bielizna_i_moda_plazowa_1%3Am&filters[rozmiar_b][begins][]=czapki_i_kapelusze_2%3Anone%3Aone_size_1&filters[cena][range]=66-421&categories[]=mezczyzni&select[]=product_active&select[]=product_badge&select[]=manufacturer&select[]=manufacturer_with_collection&select[]=clothes_size&select[]=main_color&select[]=discount&select[]=rozmiar_karta_produktu&select[]=eco_friendly&select[]=fason&select[]=final_price&select[]=footwear_size&select[]=hot_deal&select[]=images&select[]=modivo_fashion_club&select[]=model&select[]=nazwa_wyswietlana&select[]=nazwa_wyswietlana_front&select[]=okazja&select[]=price&select[]=producent&select[]=product_group_associated&select[]=series_name&select[]=size_type&select[]=index&select[]=akcje_marketingowe&select[]=url_key&select[]=video_url&select[]=okazja&select[]=producent&select[]=footwear_size&select[]=clothes_size&select[]=health_beauty_size&select[]=home_decor_size&select[]=eco_friendly&select[]=modivo_fashion_club&select[]=action_label&select[]=product_color_variants_count&select[]=omnibus_price&select[]=omnibus_discount&select[]=short_name&select[]=outlet&support_aggregated_size_b=1
//https://modivo.pl/t-api/rest/search/modivo/v5/search_web3?channel=modivo&currency=PLN&locale=pl_PL&limit=72&page=1&filters[akcja][in][]=bestsellers_1&filters[omnibus_discount][range]=0-1&filters[rozmiar_b][begins][]=obuwie_1%3Anone%3A35_1&filters[rozmiar_b][begins][]=skarpetki_1%3Anone%3A41_2&filters[rozmiar_b][begins][]=bielizna_i_moda_plazowa_1%3Am&filters[rozmiar_b][begins][]=czapki_i_kapelusze_2%3Anone%3Am&filters[rozmiar_b][begins][]=czapki_i_kapelusze_2%3Anone%3Al&filters[rozmiar_b][begins][]=czapki_i_kapelusze_2%3Anone%3Aone_size_1&filters[cena][range]=66-421&categories[]=mezczyzni&select[]=product_active&select[]=product_badge&select[]=manufacturer&select[]=manufacturer_with_collection&select[]=clothes_size&select[]=main_color&select[]=discount&select[]=rozmiar_karta_produktu&select[]=eco_friendly&select[]=fason&select[]=final_price&select[]=footwear_size&select[]=hot_deal&select[]=images&select[]=modivo_fashion_club&select[]=model&select[]=nazwa_wyswietlana&select[]=nazwa_wyswietlana_front&select[]=okazja&select[]=price&select[]=producent&select[]=product_group_associated&select[]=series_name&select[]=size_type&select[]=index&select[]=akcje_marketingowe&select[]=url_key&select[]=video_url&select[]=okazja&select[]=producent&select[]=footwear_size&select[]=clothes_size&select[]=health_beauty_size&select[]=home_decor_size&select[]=eco_friendly&select[]=modivo_fashion_club&select[]=action_label&select[]=product_color_variants_count&select[]=omnibus_price&select[]=omnibus_discount&select[]=short_name&select[]=outlet&support_aggregated_size_b=1
//https://modivo.pl/t-api/rest/search/modivo/v5/search_web3?channel=modivo&currency=PLN&locale=pl_PL&limit=72&page=1&filters[oferta][in][]=nowosc&filters[rozmiar_b][begins][]=odziez%3Axxs&filters[rozmiar_b][begins][]=odziez%3Aone_size&filters[rozmiar_b][begins][]=odziez%3Axs%3A24_2&filters[rozmiar_b][begins][]=spodnie_jeansy_i_shorty%3Axl&filters[rozmiar_b][begins][]=biustonosze%3Anone%3A70g&filters[rozmiar_b][begins][]=bielizna_i_moda_plazowa%3Anone%3A85b&categories[]=kobiety%2Fodziez&select[]=product_active&select[]=product_badge&select[]=manufacturer&select[]=manufacturer_with_collection&select[]=clothes_size&select[]=main_color&select[]=discount&select[]=rozmiar_karta_produktu&select[]=eco_friendly&select[]=fason&select[]=final_price&select[]=footwear_size&select[]=hot_deal&select[]=images&select[]=modivo_fashion_club&select[]=model&select[]=nazwa_wyswietlana&select[]=nazwa_wyswietlana_front&select[]=okazja&select[]=price&select[]=producent&select[]=product_group_associated&select[]=series_name&select[]=size_type&select[]=index&select[]=akcje_marketingowe&select[]=url_key&select[]=video_url&select[]=okazja&select[]=producent&select[]=footwear_size&select[]=clothes_size&select[]=health_beauty_size&select[]=home_decor_size&select[]=eco_friendly&select[]=modivo_fashion_club&select[]=action_label&select[]=product_color_variants_count&select[]=omnibus_price&select[]=omnibus_discount&select[]=short_name&select[]=outlet&support_aggregated_size_b=1
import fs from "fs";
import { size } from "lodash";
import { getGenderById } from "../database/profiles";
type SortType = "price" | "created";
type SortOrder = "asc" | "desc";

class ModivoData {
  maleDataFilePath: string = "./src/modivo/data/male_filters.json";
  femaleDataFilePath: string = "./src/modivo/data/female_filters.json";
  maleData: GenderedInformation;
  femaleData: GenderedInformation;
  constructor() {
    this.loadModivoData();
  }
  async loadGenderedData() {
    this.maleData = new GenderedInformation(0, this.maleDataFilePath);
    this.femaleData = new GenderedInformation(1, this.femaleDataFilePath);
    await this.maleData.populateGender();
    await this.femaleData.populateGender();
    this.maleData.parseFilters(this.maleDataFilePath);
    this.femaleData.parseFilters(this.femaleDataFilePath);
    return this;
  }
  loadModivoData() {
    this.loadGenderedData();
    return this;
  }
  getSerializedModivoData() {
    return this;
  }
}

class GenderedInformation {
  gender: string;
  genderId: number;
  filtersFile: string;
  clothingSizes: Array<ClothingGroup> = [];
  constructor(genderId: number, filtersFile: string) {
    this.genderId = genderId;
    this.filtersFile = filtersFile;
  }
  async populateGender() {
    const gender = await getGenderById(this.genderId.valueOf());
    if (!gender) {
      throw `Gender id ${this.genderId} not found`;
    }
    this.gender = gender.name;
  }
  parseFilters(file: string) {
    fs.readFile(`${file}`, "utf8", (err, data) => {
      if (err) throw err;
      var filters = JSON.parse(data);
      this.parseSizes(filters["aggregated_size_b"]);
    });
  }
  parseSizes(sizes: any) {
    for (var i = 0; i < sizes["options"].length; i++) {
      var jsonClothingGroup = sizes["options"][i];
      var clothingGroup = new ClothingGroup(
        jsonClothingGroup["label"],
        jsonClothingGroup["code"],
        jsonClothingGroup["url"]
      );
      for (var j = 0; j < jsonClothingGroup["options"].length; j++) {
        var clothingSizeGroup = new ClothingSize(
          jsonClothingGroup["options"][j]["code"],
          jsonClothingGroup["options"][j]["label"],
          jsonClothingGroup["options"][j]["url"],
          this.gender
        );
        clothingSizeGroup.addOptionsFromObject(
          jsonClothingGroup["options"][j]["options"],
          this.gender
        );
        clothingGroup.addSize(clothingSizeGroup);
      }
      this.clothingSizes.push(clothingGroup);
    }
  }
}
class ClothingGroup {
  name: string;
  code: string;
  url: string;
  sizes: Array<ClothingSize> = [];
  constructor(name: string, code: string, url: string) {
    this.name = name;
    this.code = code;
    this.url = url;
  }
  addSize(size: ClothingSize) {
    this.sizes.push(size);
  }
  // getSize(size: string | number){
  //   if (
  //       typeof size === "string" &&
  //       this.sizes.includes(size.toLowerCase())
  //     ) {
  //       for (var i = 0; i < this.sizes.length; i++) {
  //           if (this.sizes[i].size.toLowerCase() == size.toLowerCase()) {
  //               return this.sizes[i];
  //           }
  //       }
  //       this.size = size.toLowerCase();
  //     }
  //     if (typeof size === "number" && this.sizes.length >= size) {
  //       this.size = this.sizes[size];
  //     }
  // }
}
class ClothingSize {
  name: string;
  gender: string;
  size: string;
  url: string;
  options?: Array<ClothingSize> = [];
  largestSize: number = 0;

  constructor(name: string, size: string, url: string, gender: string) {
    this.name = name;
    this.size = size;
    this.url = url;
    this.gender = gender;
  }
  addOption(option: ClothingSize) {
    this.options.push(option);
    if (!isNaN(Number(option.size))) {
      if (this.largestSize < parseInt(option.size)) {
        this.largestSize = parseInt(option.size);
      }
    }
  }
  addOptionsFromObject(options: any, gender: string) {
    for (var i = 0; i < options.length; i++) {
      var clothingSize = new ClothingSize(
        options[i]["code"],
        options[i]["label"],
        options[i]["url"],
        gender
      );
      this.addOption(clothingSize);
    }
  }
  getOptionBySize(size: string) {
    for (var i = 0; i < this.options.length; i++) {
      if (this.options[i].size.toLowerCase() == size.toLowerCase()) {
        return this.options[i];
      }
    }
  }
}

class Clothing {
  name: string;
  sizes: Array<string>;
  constructor(name: string, sizes: Array<string>) {
    this.name = name;
    this.sizes = sizes;
  }
  size: string | undefined;
  getString(option?: number | string | null) {
    if (option != null) {
      if (
        typeof option === "string" &&
        this.sizes.includes(option.toLowerCase())
      ) {
        this.size = option.toLowerCase();
      }
      if (typeof option === "number" && this.sizes.length >= option) {
        this.size = this.sizes[option];
      }
    }
  }
}

class Filters {
  categories: String;
  select: Array<String>;
  sortType: SortType;
  sortOrder: SortOrder;
  constructor() {
    this.select = [
      "product_active",
      "product_badge",
      "manufacturer",
      "manufacturer_with_collection",
      "clothes_size",
      "main_color",
      "discount",
      "rozmiar_karta_produktu",
      "eco_friendly",
      "fason",
      "final_price",
      "footwear_size",
      "hot_deal",
      "images",
      "modivo_fashion_club",
      "model",
      "nazwa_wyswietlana",
      "nazwa_wyswietlana_front",
      "okazja",
      "price",
      "producent",
      "product_group_associated",
      "series_name",
      "size_type",
      "index",
      "akcje_marketingowe",
      "url_key",
      "video_url",
      "okazja",
      "producent",
      "footwear_size",
      "clothes_size",
      "health_beauty_size",
      "home_decor_size",
      "eco_friendly",
      "modivo_fashion_club",
      "action_label",
      "product_color_variants_count",
      "omnibus_price",
      "omnibus_discount",
      "short_name",
      "outlet",
    ];
  }
  setSortOrder(type: SortType, order: SortOrder) {
    this.sortType = type;
    this.sortOrder = order;
  }
}

class ModivoProductQueryCreator {
  url: string;
  name: string;
  limit: number;
  page: number;
  channel: string;
  locale: string;
  currency: string;
  supportAggregatedSizeB: number;
  constructor(name: string) {
    this.name = name;
    this.limit = 72;
    this.page = 1;
    this.channel = "modivo";
    this.locale = "pl_PL";
    this.currency = "PLN";
    this.url = `https://modivo.pl/t-api/rest/search/modivo/v5/search_web`;
    //3?channel=modivo&currency=PLN&locale=pl_PL&limit=${this.limit}&page=${this.page}
    this.supportAggregatedSizeB = 1;
  }
}

var modivoData = new ModivoData();
modivoData.loadGenderedData();
export const getModivoStoredData = () => {
  return modivoData.getSerializedModivoData();
};
